{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto">
  <!-- Header -->
  <div class="glass-effect rounded-2xl p-6 mb-8 text-center">
    <div class="flex items-center justify-center mb-4">
      <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mr-4">
        <i class="fas fa-comments text-white text-2xl"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-slate-800 mb-1">Document Assistant</h1>
        <p class="text-slate-600">Let's fill your document together</p>
      </div>
    </div>
    <div class="flex items-center justify-center space-x-2 text-slate-500">
      <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
      <span class="text-sm">AI Assistant is ready</span>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="glass-effect rounded-3xl p-8 mb-6">
    <div id="chat-box" class="space-y-6">
      {% if show_confirmation %}
      <!-- Previous Answer Confirmation -->
      <div class="flex items-start space-x-4 mb-6">
        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center">
          <i class="fas fa-check text-white"></i>
        </div>
        <div class="flex-1">
          <div class="bg-green-100 border border-green-200 rounded-2xl rounded-bl-sm p-4 shadow-sm">
            <p class="text-green-800">✅ Got it! Your answer has been saved.</p>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- AI Message -->
      <div class="flex items-start space-x-4">
        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
          <i class="fas fa-robot text-white"></i>
        </div>
        <div class="flex-1">
          <div class="bg-slate-100 rounded-2xl rounded-tl-sm p-6 border border-slate-200 shadow-lg">
            <div class="mb-4">
              <div class="flex items-center justify-between mb-3">
                <span class="text-slate-600 text-sm font-medium">AI Assistant</span>
                <span class="text-blue-600 text-sm font-semibold">{{ (index + 1) }}/{{ total_questions if total_questions else '?' }}</span>
              </div>
              <p class="text-slate-800 text-lg leading-relaxed font-medium">{{ question }}</p>
            </div>
            <div class="flex items-center text-slate-500 text-sm">
              <i class="fas fa-lightbulb mr-2"></i>
              <span>Provide the most accurate information possible</span>
            </div>
          </div>
        </div>
      </div>

      <!-- User Input Form -->
      <form hx-post="/fill" hx-target="#chat-box" hx-swap="innerHTML" class="flex items-end space-x-4">
        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center">
          <i class="fas fa-user text-white"></i>
        </div>
        <div class="flex-1">
          <div class="bg-white rounded-2xl rounded-bl-sm p-4 border border-slate-200 shadow-lg">
            <textarea 
              name="answer" 
              placeholder="Type your answer here..." 
              class="w-full bg-transparent text-slate-800 placeholder-slate-500 resize-none focus:outline-none text-lg answer-textarea"
              rows="3"
              required
            ></textarea>
            <input type="hidden" name="index" value="{{ index }}" />
            <div class="flex items-center justify-between mt-4">
              <div class="flex items-center text-slate-500 text-sm">
                <i class="fas fa-info-circle mr-2"></i>
                <span>Press Enter to send, Shift+Enter for new line</span>
              </div>
              <button type="submit" class="btn-primary font-semibold py-3 px-6 rounded-xl flex items-center space-x-2">
                <span>Send</span>
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Simple Progress Info inside chat-box so it gets updated -->
      <div class="glass-effect rounded-2xl p-4 text-center mt-6">
        <div class="flex items-center justify-center space-x-2 text-slate-600">
          <i class="fas fa-clipboard-list text-blue-500"></i>
          <span class="text-sm">Question {{ (index + 1) }} of {{ total_questions if total_questions else '?' }}</span>
          <span class="text-xs text-slate-400">•</span>
          <span class="text-sm">Keep going! You're doing great.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom scrollbar */
  .chat-messages::-webkit-scrollbar {
    width: 4px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
  }
  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
</style>

<script>
// Handle Enter key submission for textareas
function setupTextareaHandlers() {
  const textarea = document.querySelector('textarea[name="answer"]');
  if (textarea) {
    // Remove any existing event listeners to prevent duplicates
    textarea.removeEventListener('keydown', handleEnterKey);
    // Add the Enter key handler
    textarea.addEventListener('keydown', handleEnterKey);
    textarea.focus();
  }
}

function handleEnterKey(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    const form = this.closest('form');
    if (form) {
      // Trigger the form submission
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.click();
      }
    }
  }
}

// Auto-focus on textarea when page loads
document.addEventListener('DOMContentLoaded', function() {
  setupTextareaHandlers();
});

// Handle HTMX events
document.body.addEventListener('htmx:afterSwap', function(event) {
  // Re-setup textarea handlers after HTMX swap
  setupTextareaHandlers();
  
  // Smooth scroll to keep the conversation in view
  const chatBox = document.getElementById('chat-box');
  if (chatBox) {
    chatBox.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }
  
  // Extract and update the question counter from the AI assistant message
  const aiCounter = document.querySelector('.text-blue-600.text-sm.font-semibold');
  const progressInfo = document.querySelector('.glass-effect .text-sm');
  if (aiCounter && progressInfo) {
    const counterText = aiCounter.textContent;
    progressInfo.innerHTML = `Question ${counterText}`;
  }
});

// Form submission handling
document.addEventListener('submit', function(event) {
  if (event.target.matches('form[hx-post="/fill"]')) {
    const button = event.target.querySelector('button[type="submit"]');
    const span = button.querySelector('span');
    const icon = button.querySelector('i');
    
    span.textContent = 'Sending...';
    icon.className = 'fas fa-spinner animate-spin';
    button.disabled = true;
  }
});
</script>
{% endblock %}
